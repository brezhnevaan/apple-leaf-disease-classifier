# Apple Leaf Disease Classifier

Проект посвящён задаче классификации заболеваний листьев яблони по фотографиям с использованием методов компьютерного зрения и глубокого обучения.

---

## 1. Описание проекта

### Постановка задачи

Рассматривается задача многоклассовой и мультилейбл классификации — определение заболеваний листьев яблони по RGB-фотографиям, сделанным в полевых условиях.
Целью является обучение модели компьютерного зрения, способной автоматически определять тип заболевания по изображению листа.

### Практическая применимость

Практическая ценность решения заключается в возможности мониторинга состояния яблоневых садов с целью:

- раннего выявления заболеваний;
- предотвращения их распространения на всю плантацию;
- снижения потерь урожая.

---

### Формат входных и выходных данных

**Входные данные (обучение):**

- цветные RGB изображения листьев яблони в формате `jpg`;
- CSV-файл с описанием:
  - имя файла изображения;
  - один или несколько лейблов заболеваний (мультилейбл).

**Выходные данные:**

- вектор вероятностей принадлежности изображения к каждому классу заболеваний.

---

### Метрики качества

Основные метрики качества модели:

- **F1 score (macro)** — основная целевая метрика, характеризующая общее качество модели;

Вспомогательные метрики:

- accuracy;
- precision;
- recall (в том числе по классам).

Ожидаемое качество:

- бейзлайн: ~0.60 F1 macro;
- финальное решение: ~0.70 F1 macro.

---

### Валидация и тестирование

Данные разбиваются на:

- train;
- validation;
- test.

Разбиение выполняется с помощью `train_test_split` из `sklearn` с фиксированным `random_state`.
Test-выборка используется как финальный holdout и не участвует в подборе гиперпараметров.

---

### Датасет

Используется открытый датасет с [Kaggle](https://www.kaggle.com/competitions/plant-pathology-2021-fgvc8/data):

- около **16.8k изображений** листьев яблони;
- суммарный объём изображений — ~16 GB;
- CSV-файл с разметкой — ~586 KB.

Особенности данных:

- фотографии сняты в реальных условиях;
- присутствуют шум и разное освещение;
- часть изображений имеет мультилейбл;
- классы несбалансированы.

---

### Моделирование

#### Бейзлайн

В качестве бейзлайна реализована собственная CNN-архитектура на PyTorch:

- несколько Conv + MaxPool слоёв;
- функция потерь — `BCEWithLogitsLoss`;
- целевое качество — ~0.60 F1 macro.

#### Основная модель

В качестве основной модели используется предобученная **ResNet18**.

Обучение проводится в два этапа:

1. обучение классификатора при замороженном backbone;
2. fine-tuning последних слоёв backbone с пониженным learning rate.

---

## 2. Технические детали

### Setup

Проект использует:

- Python **3.10**,
- менеджер зависимостей **uv**,
- **Hydra** для конфигураций,
- **DVC** для управления данными,
- **PyTorch Lightning** для обучения,
- **MLflow** для логирования экспериментов.

#### Настройка окружения

Производится следующими командами:

```bash
# Клонирование репозитория
git clone https://github.com/brezhnevaan/apple-leaf-disease-classifier.git
cd apple-leaf-disease-classifier

# Создания виртуального окружения
python3.10 -m venv .venv
source .venv/bin/activate

# Установка uv и закрепленных в нем зависимостей
python -m pip install -U pip uv
uv sync

# Обучение
uv run python -m apple_leaf_disease.commands
```

**Обратите внимание** — при первичном запуске происходит скачивание данных из Yandex Object Storage, поэтому вызов commands может занять время!
Само подключение к хранилищу тоже происходит с лагом в несколько минут, поэтому, до того как появится прогресс бар с загрузкой данных, терминал может "повиснуть" после ввода команды — это ожидаемое и оттестированное поведение, загрузка стартует после паузы.

### Train

Как было написано в предыдущем разделе, обучение запускается с помощью команды:

```bash
uv run python -m apple_leaf_disease.commands
```

Однако в репозитории представлены 2 модели — собранный на PyTorch с нуля baseline и файнтюнинг Resnet18. По умочанию при запуске commands стартует обучение Resnet18.
Управлять выбором моделей можно через CLI:

```bash
# baseline
uv run python -m apple_leaf_disease.commands model.name=baseline

# resnet18 или запуск по умолчанию
uv run python -m apple_leaf_disease.commands model.name=resnet18
```

Переопределение любых параметров возможно через CLI (Hydra overrides), например:

```bash
uv run python -m apple_leaf_disease.commands model.name=baseline train.max_epochs=3 data.batch_size=8
```

#### Логирование

Для логирования используется MLflow (tracking server по адресу 127.0.0.1:8080).
Запуск MLflow сервера:

```bash
uv run mlflow server --host 127.0.0.1 --port 8080
```

В MLflow логируются:

- train и validation loss,
- метрики качества (F1, precision, recall),
- все используемые гиперпараметры,
- hash коммита git.
